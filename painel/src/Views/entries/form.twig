{% extends "layouts/admin.twig" %}

{% block content %}
<div class="row">
  <div class="col-12 col-xl-8">
    <div class="card mb-4">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0 text-capitalize" id="formHeaderTitle">Carregando Módulo...</h5>
      </div>
      <div class="card-body">
        <div id="loadingIndicator" class="text-center py-5">
            <i class="bx bx-loader-alt bx-spin bx-md text-primary mb-3"></i>
            <p>Construindo Interface via Schema EAV...</p>
        </div>
        <form id="dynamicEntryForm" style="display: none;">
            <div id="formFieldsContainer" class="row g-4"></div>
            <div class="mt-4 pt-3 border-top">
                <button type="submit" class="btn btn-primary" id="btnSubmit">
                    <i class="bx bx-save me-1"></i> Salvar Registro
                </button>
                <a href="/entries/{{ type_slug }}" class="btn btn-label-secondary">Cancelar</a>
            </div>
        </form>
      </div>
    </div>
  </div>
  
  <div class="col-12 col-xl-4">
      <div class="card">
        <div class="card-body">
            <h6 class="card-title text-uppercase text-muted mb-3">Status de Publicação</h6>
            <select class="form-select mb-3" id="entryStatus">
                <option value="published">Publicado (Online)</option>
                <option value="draft">Rascunho (Offline)</option>
            </select>
            <small class="text-muted">Itens em rascunho não são expostos pela API pública.</small>
        </div>
      </div>
  </div>
</div>
{% endblock %}

{% block page_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const token = localStorage.getItem('santis_jwt');
    const slug = '{{ type_slug }}';
    const entryId = '{{ entry_id|default('') }}';
    const isEdit = entryId !== '';
    const container = document.getElementById('formFieldsContainer');
    const form = document.getElementById('dynamicEntryForm');
    const loader = document.getElementById('loadingIndicator');
    const headerTitle = document.getElementById('formHeaderTitle');

    // Load Schema and Data
    const p1 = fetch('/api/secure/types', { headers: { 'Authorization': 'Bearer '+token } }).then(r => r.json());
    const p2 = isEdit ? fetch(`/api/secure/entries/${slug}/${entryId}`, { headers: { 'Authorization': 'Bearer '+token } }).then(r => r.json()) : Promise.resolve({success:true, data:null});

    Promise.all([p1, p2]).then(([schemaRes, dataRes]) => {
        if (!schemaRes.success) throw new Error('Falha ao carregar configuração do módulo.');
        
        const typeModel = schemaRes.data.find(t => t.slug.toLowerCase() === slug.toLowerCase());
        if (!typeModel) throw new Error('Módulo não encontrado.');

        const schema = typeModel.schema || [];
        const entryData = dataRes.data;

        headerTitle.innerText = isEdit ? 'Editar Entrada: ' + (entryData.title || typeModel.name) : 'Nova Entrada: ' + typeModel.name;
        if (isEdit) document.getElementById('entryStatus').value = entryData.status;

        renderFields(schema, entryData ? entryData.content_data : null);
        loader.style.display = 'none';
        form.style.display = 'block';

    }).catch(err => {
        loader.innerHTML = `<div class="alert alert-danger">${err.message}</div>`;
    });

    function renderFields(schema, values) {
        if (!Array.isArray(schema) || schema.length === 0) {
            container.innerHTML = '<div class="col-12"><div class="alert alert-warning">Nenhum campo configurado neste módulo.</div></div>';
            return;
        }

        let html = '';
        // Sort by order safely
        const sorted = [...schema].sort((a,b) => (parseInt(a.order)||0) - (parseInt(b.order)||0));
        
        sorted.forEach(f => {
            const val = (values && values[f.key]) ? values[f.key] : '';
            const req = f.required ? 'required' : '';
            const star = f.required ? '<span class="text-danger">*</span>' : '';
            
            html += `<div class="col-12"><label class="form-label">${f.label} ${star}</label>`;
            
            if (f.type === 'textarea') {
                html += `<textarea class="form-control dynamic-input" data-key="${f.key}" rows="3" ${req}>${val}</textarea>`;
            } else if (f.type === 'richtext') {
                html += `<textarea class="form-control dynamic-input bg-light" data-key="${f.key}" rows="6" ${req}>${val}</textarea>`;
            } else if (f.type === 'boolean') {
                const checked = (val === true || val === 'true' || val === 1) ? 'checked' : '';
                html += `<div class="form-check form-switch mt-1"><input class="form-check-input dynamic-input" type="checkbox" data-key="${f.key}" ${checked}></div>`;
            } else if (f.type === 'image') {
                html += `<input type="text" class="form-control dynamic-input" data-key="${f.key}" value="${val}" placeholder="/uploads/..." ${req}>`;
            } else {
                html += `<input type="${f.type === 'url' ? 'url' : (f.type === 'date' ? 'date' : 'text')}" class="form-control dynamic-input" data-key="${f.key}" value="${val}" ${req}>`;
            }
            html += `</div>`;
        });
        container.innerHTML = html;
    }

    form.addEventListener('submit', function(e) {
        e.preventDefault();
        const btn = document.getElementById('btnSubmit');
        btn.disabled = true;

        const contentData = {};
        form.querySelectorAll('.dynamic-input').forEach(inp => {
            contentData[inp.getAttribute('data-key')] = inp.type === 'checkbox' ? inp.checked : inp.value;
        });

        // Título é sempre o primeiro campo ou o campo 'titulo'/'nome'
        const titleField = contentData.titulo || contentData.nome || contentData.title || Object.values(contentData)[0] || 'Sem Título';

        const payload = {
            title: titleField,
            slug: titleField.toString().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, "").replace(/[^\w\s-]/g, '').replace(/[\s_-]+/g, '-'),
            status: document.getElementById('entryStatus').value,
            content_data: contentData
        };

        fetch(isEdit ? `/api/secure/entries/${slug}/${entryId}` : `/api/secure/entries/${slug}`, {
            method: isEdit ? 'PUT' : 'POST',
            headers: { 'Authorization': 'Bearer '+token, 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        })
        .then(r => r.json())
        .then(res => {
            if (res.success) window.location.href = `/entries/${slug}`;
            else { alert(res.message); btn.disabled = false; }
        });
    });
});
</script>
{% endblock %}
